//! Generates TypeScript type definitions from Rust structs.
//!
//! Run with: cargo run --bin export_types
//!
//! Output goes to ../frontend/src/lib/generated/

use std::fs;
use std::path::Path;

use redgrouse::api_constants;
use redgrouse::error::ApiErrorBody;
use redgrouse::filter::{
    Combinator, Condition, FieldMetadata, FilterField, FilterGroup, FilterValue, Operator, Rule,
};
use redgrouse::sightings::{Sighting, SightingsResponse, SortField};
use redgrouse::upload::{DeleteResponse, UpdateResponse, UploadResponse};
use ts_rs::TS;

fn main() {
    let out_dir = Path::new("../frontend/src/lib/generated");

    if out_dir.exists() {
        fs::remove_dir_all(out_dir).expect("Failed to clean output directory");
    }
    fs::create_dir_all(out_dir).expect("Failed to create output directory");

    // Export all types
    ApiErrorBody::export_all_to(out_dir).expect("Failed to export ApiErrorBody");
    Combinator::export_all_to(out_dir).expect("Failed to export Combinator");
    Operator::export_all_to(out_dir).expect("Failed to export Operator");
    FilterField::export_all_to(out_dir).expect("Failed to export FilterField");
    FilterValue::export_all_to(out_dir).expect("Failed to export FilterValue");
    Condition::export_all_to(out_dir).expect("Failed to export Condition");
    Rule::export_all_to(out_dir).expect("Failed to export Rule");
    FilterGroup::export_all_to(out_dir).expect("Failed to export FilterGroup");
    FieldMetadata::export_all_to(out_dir).expect("Failed to export FieldMetadata");
    Sighting::export_all_to(out_dir).expect("Failed to export Sighting");
    SightingsResponse::export_all_to(out_dir).expect("Failed to export SightingsResponse");
    SortField::export_all_to(out_dir).expect("Failed to export SortField");
    UploadResponse::export_all_to(out_dir).expect("Failed to export UploadResponse");
    UpdateResponse::export_all_to(out_dir).expect("Failed to export UpdateResponse");
    DeleteResponse::export_all_to(out_dir).expect("Failed to export DeleteResponse");

    // Export constants
    let constants_content = format!(
        "// Auto-generated by backend/src/bin/export_types.rs\n\
         // Do not edit manually\n\n\
         export const HEALTH_ROUTE = \"{}\";\n\
         export const VERSION_ROUTE = \"{}\";\n\
         export const UPLOAD_ROUTE = \"{}\";\n\
         export const UPLOAD_DETAILS_ROUTE = \"{}\";\n\
         export const UPLOAD_COUNT_ROUTE = \"{}\";\n\
         export const UPLOAD_BBOX_ROUTE = \"{}\";\n\
         export const UPLOAD_SIGHTINGS_ROUTE = \"{}\";\n\
         export const TILE_ROUTE = \"{}\";\n\
         export const FIELDS_ROUTE = \"{}\";\n\
         export const FIELD_VALUES_ROUTE = \"{}\";\n\
         export const DEFAULT_PAGE_SIZE = {};\n\
         export const MAX_PAGE_SIZE = {};\n",
        api_constants::HEALTH_ROUTE,
        api_constants::VERSION_ROUTE,
        api_constants::UPLOAD_ROUTE,
        api_constants::UPLOAD_DETAILS_ROUTE,
        api_constants::UPLOAD_COUNT_ROUTE,
        api_constants::UPLOAD_BBOX_ROUTE,
        api_constants::UPLOAD_SIGHTINGS_ROUTE,
        api_constants::TILE_ROUTE,
        api_constants::FIELDS_ROUTE,
        api_constants::FIELD_VALUES_ROUTE,
        api_constants::DEFAULT_PAGE_SIZE,
        api_constants::MAX_PAGE_SIZE
    );
    fs::write(out_dir.join("api_constants.ts"), constants_content)
        .expect("Failed to write api_constants.ts");

    // Generate index.ts by scanning exported files
    let mut type_names: Vec<String> = fs::read_dir(out_dir)
        .expect("Failed to read output directory")
        .filter_map(|entry| {
            let entry = entry.ok()?;
            let path = entry.path();
            let name = path.file_stem()?.to_str()?;
            if path.extension().is_some_and(|ext| ext == "ts") && name != "index" {
                Some(name.to_string())
            } else {
                None
            }
        })
        .collect();

    type_names.sort();

    let mut index_content = String::from(
        "// Auto-generated by backend/src/bin/export_types.rs\n\
         // Do not edit manually - run `cargo run --bin export_types` to regenerate\n\n",
    );
    for name in &type_names {
        if name == "api_constants" {
            index_content.push_str(&format!("export * from \"./{name}\";\n"));
        } else {
            index_content.push_str(&format!(
                "export type {{ {} }} from \"./{}\";\n",
                name, name
            ));
        }
    }

    fs::write(out_dir.join("index.ts"), index_content).expect("Failed to write index.ts");

    println!("TypeScript types exported to {:?}", out_dir);
}
