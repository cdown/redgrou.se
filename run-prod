#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")"

# Configuration
DATA_DIR="${REDGROUSE_DATA_DIR:-$PWD/data}"
BACKEND_PORT="${REDGROUSE_BACKEND_PORT:-3001}"
FRONTEND_PORT="${REDGROUSE_FRONTEND_PORT:-3000}"

mkdir -p "$DATA_DIR"

# Always build both (version hash must match)
echo "Building backend..."
(cd backend && touch build.rs && RUSTFLAGS="-C target-cpu=native" cargo build --release)

echo "Building frontend..."
(cd frontend && npm ci && NEXT_PUBLIC_API_URL="" npm run build)

# Cleanup on exit
cleanup() {
    echo "Shutting down..."
    # Kill entire process trees (npm spawns next as a child process)
    pkill -TERM -P $FRONTEND_PID 2>/dev/null || true
    kill $BACKEND_PID $FRONTEND_PID 2>/dev/null || true
    wait
}
trap cleanup EXIT INT TERM

# Start backend
echo "Starting backend on port $BACKEND_PORT..."
DATABASE_URL="sqlite:$DATA_DIR/redgrouse.db" \
RUST_LOG=info \
    backend/target/release/redgrouse &
BACKEND_PID=$!

# Start frontend (--prefix avoids subshell, keeping PID tracking accurate)
echo "Starting frontend on port $FRONTEND_PORT..."
PORT=$FRONTEND_PORT npm run start --prefix frontend &
FRONTEND_PID=$!

echo "redgrou.se running"
echo "  Frontend: http://localhost:$FRONTEND_PORT"
echo "  Backend:  http://localhost:$BACKEND_PORT"
echo "  Data:     $DATA_DIR"
echo ""
echo "Press Ctrl+C to stop"

wait
